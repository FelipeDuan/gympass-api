name: Deploy Production

on:
  push:
    branches: ['main']
    tags:
      - 'v*.*.*' # Trigger em tags de vers√£o (ex: v1.0.0)
  workflow_dispatch:
    inputs:
      version:
        description: 'Vers√£o para deploy (ex: 1.2.3)'
        required: true
        type: string
      skip_tests:
        description: 'Pular testes? (n√£o recomendado)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  test:
    name: Run Tests Before Deploy
    if: github.event.inputs.skip_tests != 'true'
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: gympass_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Instalar pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.3

      - name: Instalar depend√™ncias
        run: pnpm install --frozen-lockfile

      - name: Gerar Prisma Client
        run: pnpm db:generate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/gympass_test

      - name: Rodar migrations
        run: pnpm db:migrate:deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/gympass_test

      - name: Testes
        run: pnpm test:cov
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/gympass_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-secret-key-minimum-32-characters-long
          NODE_ENV: test

  build:
    name: Build Production Image
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Instalar pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.3

      - name: Instalar depend√™ncias
        run: pnpm install --frozen-lockfile

      - name: Build aplica√ß√£o
        run: pnpm build

      - name: Login no GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build e Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Criar Release (se tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ env.VERSION }}
          draft: false
          prerelease: false

  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://api.gympass.com # Atualize com sua URL real

    steps:
      - name: Deploy para Produ√ß√£o
        run: |
          echo "üöÄ Deployando vers√£o ${{ env.VERSION }} para produ√ß√£o..."
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
          echo ""
          echo "‚ö†Ô∏è  Configure seu ambiente de produ√ß√£o para usar esta imagem"
          echo "Exemplo com docker-compose:"
          echo "  docker-compose -f docker-compose.prod.yml pull"
          echo "  docker-compose -f docker-compose.prod.yml up -d"
          echo ""
          echo "Ou com Kubernetes:"
          echo "  kubectl set image deployment/api api=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
          echo "  kubectl rollout status deployment/api"

      - name: Health Check
        if: env.PRODUCTION_URL != ''
        run: |
          echo "‚è≥ Aguardando aplica√ß√£o iniciar..."
          sleep 30
          
          for i in {1..15}; do
            HEALTH_RESPONSE=$(curl -sf "${{ env.PRODUCTION_URL }}/health" || echo "")
            if [ -n "$HEALTH_RESPONSE" ]; then
              echo "‚úÖ Health check passou!"
              echo "$HEALTH_RESPONSE" | jq '.' || echo "$HEALTH_RESPONSE"
              exit 0
            fi
            echo "Tentativa $i/15..."
            sleep 10
          done
          
          echo "‚ùå Health check falhou ap√≥s 15 tentativas"
          exit 1
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL || '' }}

      - name: Smoke Tests
        if: env.PRODUCTION_URL != ''
        run: |
          echo "üß™ Rodando smoke tests..."
          
          # Testar health endpoint
          curl -f "${{ env.PRODUCTION_URL }}/health" || exit 1
          
          # Adicionar mais testes conforme necess√°rio
          echo "‚úÖ Smoke tests passaram!"
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL || '' }}

      - name: Notificar Sucesso
        if: success()
        run: |
          echo "‚úÖ Deploy para produ√ß√£o conclu√≠do com sucesso!"
          echo "Vers√£o: ${{ env.VERSION }}"
          echo "Commit: ${{ github.sha }}"
          # Adicionar notifica√ß√£o Slack/Email aqui se necess√°rio

      - name: Notificar Falha
        if: failure()
        run: |
          echo "‚ùå Deploy para produ√ß√£o falhou!"
          echo "Vers√£o: ${{ env.VERSION }}"
          echo "Commit: ${{ github.sha }}"
          # Adicionar notifica√ß√£o Slack/Email aqui se necess√°rio
          exit 1

