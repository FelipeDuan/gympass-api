# üèõÔ∏è RULES GLOBAIS DO PROJETO - API Solid

**Vers√£o:** 1.0.0  
**Objetivo:** Governar padr√µes arquiteturais e garantir consist√™ncia, coes√£o e longevidade t√©cnica  
**Stack:** Node.js + TypeScript + Fastify + PostgreSQL + Redis

---

## üìã CONTEXTO E VIS√ÉO DO PROJETO

### Vis√£o Estrat√©gica

Este reposit√≥rio representa uma **base arquitetural em evolu√ß√£o** que visa se tornar um **boilerplate backend enterprise de n√≠vel s√™nior**, reutiliz√°vel em m√∫ltiplos projetos de diferentes tamanhos e complexidades.

**N√£o estamos construindo apenas uma aplica√ß√£o**, estamos estabelecendo **fundamentos t√©cnicos que duram anos**, s√£o mantidos por m√∫ltiplos times, escalam sem se tornarem ca√≥ticos e permitem que desenvolvedores **foquem quase exclusivamente nas regras de neg√≥cio**.

### O Que Estamos Construindo

**Objetivo Principal:**
Criar uma **base t√©cnica s√≥lida, madura e robusta** que sirva como ponto de partida para qualquer projeto backend Node.js, garantindo:

1. **Qualidade T√©cnica Superior**
   - C√≥digo limpo, test√°vel e manuten√≠vel
   - Arquitetura bem definida e consistente
   - Padr√µes claros e previs√≠veis
   - Separa√ß√£o absoluta de responsabilidades

2. **Developer Experience Otimizada**
   - Desenvolvimento de novos m√≥dulos seja simples e r√°pido
   - Padr√µes claros reduzam esfor√ßo cognitivo
   - Conven√ß√µes previs√≠veis facilitem onboarding
   - Foco no desenvolvimento de regras de neg√≥cio, n√£o em configura√ß√£o

3. **Longevidade e Escalabilidade**
   - C√≥digo que resiste ao tempo
   - Arquitetura que escala sem degrada√ß√£o
   - Refatora√ß√µes seguras e graduais
   - Base para evolu√ß√£o cont√≠nua

4. **Reutiliza√ß√£o Enterprise**
   - Boilerplate reutiliz√°vel em m√∫ltiplos projetos
   - Padr√µes estabelecidos e documentados
   - Estrutura que facilita manuten√ß√£o por diferentes times
   - Base t√©cnica confi√°vel para produtos cr√≠ticos

### Princ√≠pios Fundamentais Que Pregamos

**1. Pragmatismo sobre Dogmas**
- Aplicamos princ√≠pios SOLID e Clean Code rigorosamente
- Evitamos overengineering e complexidade desnecess√°ria
- Escolhemos a melhor abordagem para cada situa√ß√£o
- Priorizamos simplicidade quando poss√≠vel

**2. Separa√ß√£o Absoluta de Responsabilidades**
- Cada camada tem responsabilidade √∫nica e bem definida
- Rotas n√£o cont√™m l√≥gica de neg√≥cio
- Services n√£o conhecem detalhes de HTTP ou infraestrutura
- Repositories apenas acessam dados

**3. Testabilidade como Prioridade**
- Toda funcionalidade deve ser test√°vel
- C√≥digo deve ser f√°cil de testar isoladamente
- Testes s√£o parte do desenvolvimento, n√£o opcional
- Cobertura m√≠nima de 80% √© obrigat√≥ria

**4. Type Safety como Seguran√ßa**
- TypeScript strict mode sempre habilitado
- Tipos como ferramenta de seguran√ßa e documenta√ß√£o
- Falhas devem ocorrer preferencialmente em compile-time
- Tipagem expl√≠cita em boundaries p√∫blicos

**5. Developer Experience como Ativo**
- Conven√ß√µes claras e previs√≠veis
- Padr√µes que reduzem esfor√ßo cognitivo
- Documenta√ß√£o que facilita onboarding
- Estrutura que permite foco no que importa: regras de neg√≥cio

**6. Evolu√ß√£o Gradual e Segura**
- Refatora√ß√µes incrementais e test√°veis
- Compatibilidade durante transi√ß√µes
- Migra√ß√£o gradual quando necess√°rio
- Documenta√ß√£o de mudan√ßas arquiteturais

### O Que Pretendemos Atingir

**Curto Prazo (3-6 meses):**
- ‚úÖ Base arquitetural s√≥lida e consistente
- ‚úÖ Testes abrangentes (80%+ coverage)
- ‚úÖ Dependency Injection implementado
- ‚úÖ Desacoplamento completo de infraestrutura
- ‚úÖ Documenta√ß√£o completa e atualizada
- ‚úÖ Performance otimizada
- ‚úÖ Seguran√ßa enterprise-grade

**M√©dio Prazo (6-12 meses):**
- ‚úÖ Boilerplate completamente reutiliz√°vel
- ‚úÖ Generator de m√≥dulos funcional
- ‚úÖ Padr√µes estabelecidos e documentados
- ‚úÖ Exemplos e templates completos
- ‚úÖ CI/CD completo e otimizado
- ‚úÖ Observabilidade completa
- ‚úÖ M√©tricas e monitoramento

**Longo Prazo (12+ meses):**
- ‚úÖ Boilerplate enterprise reconhecido
- ‚úÖ Base para m√∫ltiplos projetos em produ√ß√£o
- ‚úÖ Padr√µes validados em escala
- ‚úÖ Evolu√ß√£o cont√≠nua baseada em feedback
- ‚úÖ Comunidade e contribui√ß√µes (se aplic√°vel)

### Contexto T√©cnico

**Stack Principal:**
- **Runtime:** Node.js 22.x (LTS)
- **Linguagem:** TypeScript 5.9+ (strict mode)
- **Framework:** Fastify 5.x (performance-first)
- **ORM:** Prisma 7.x (type-safe)
- **Banco:** PostgreSQL 17
- **Cache:** Redis 7
- **Valida√ß√£o:** Zod 4.x
- **Testes:** Vitest 4.x
- **Linting:** Biome 2.x

**Filosofia T√©cnica:**
- **Fastify-first:** Respeitamos o modelo de plugins, hooks e performance do Fastify
- **TypeScript como pilar:** Tipagem forte como ferramenta de seguran√ßa e documenta√ß√£o
- **Prisma como ORM:** Type-safe queries e migrations autom√°ticas
- **Zod para valida√ß√£o:** Runtime validation type-safe integrada ao Fastify
- **Testes desde o in√≠cio:** TDD quando poss√≠vel, testes obrigat√≥rios sempre

### Contexto de Neg√≥cio

**Aplica√ß√£o Atual:**
Sistema estilo GymPass com funcionalidades de:
- Autentica√ß√£o e autoriza√ß√£o (JWT + RBAC)
- Gerenciamento de usu√°rios
- Check-ins em academias
- Busca de academias por proximidade
- Valida√ß√£o de check-ins por administradores

**Mas o Objetivo Vai Al√©m:**
Este reposit√≥rio n√£o √© apenas sobre a aplica√ß√£o GymPass. √â sobre criar uma **base t√©cnica reutiliz√°vel** que pode ser usada para:
- Qualquer API REST backend
- Sistemas de diferentes dom√≠nios
- Projetos de diferentes tamanhos
- Times diferentes com necessidades diferentes

**Por Isso:**
- Focamos em padr√µes, n√£o em features espec√≠ficas
- Priorizamos arquitetura sobre funcionalidades
- Documentamos decis√µes e padr√µes
- Criamos abstra√ß√µes que facilitam extens√£o

### O Que Isso Significa na Pr√°tica

**Para Desenvolvedores:**
- Ao criar um novo m√≥dulo, voc√™ segue padr√µes claros e previs√≠veis
- N√£o precisa se preocupar com configura√ß√£o de infraestrutura
- Foca em implementar regras de neg√≥cio
- Tem testes como seguran√ßa para refatora√ß√µes

**Para o Projeto:**
- C√≥digo consistente e previs√≠vel
- F√°cil de manter e evoluir
- Test√°vel e confi√°vel
- Documentado e compreens√≠vel

**Para o Futuro:**
- Base s√≥lida para m√∫ltiplos projetos
- Padr√µes estabelecidos e validados
- Evolu√ß√£o cont√≠nua e segura
- Longevidade t√©cnica garantida

### Compromissos N√£o Negoci√°veis

**Nunca Comprometemos:**
- ‚ùå Qualidade de c√≥digo em favor de velocidade
- ‚ùå Testabilidade em favor de conveni√™ncia
- ‚ùå Separa√ß√£o de responsabilidades em favor de simplicidade aparente
- ‚ùå Type safety em favor de agilidade
- ‚ùå Documenta√ß√£o em favor de c√≥digo r√°pido

**Sempre Priorizamos:**
- ‚úÖ C√≥digo limpo e manuten√≠vel
- ‚úÖ Testes abrangentes
- ‚úÖ Arquitetura bem definida
- ‚úÖ Type safety
- ‚úÖ Documenta√ß√£o clara

---

## 1. FILOSOFIA E PRINC√çPIOS FUNDAMENTAIS

### 1.1 Princ√≠pios N√£o Negoci√°veis

- **OBRIGAT√ìRIO:** Seguir princ√≠pios SOLID rigorosamente
- **OBRIGAT√ìRIO:** Manter separa√ß√£o absoluta de responsabilidades entre camadas
- **OBRIGAT√ìRIO:** Priorizar pragmatismo sobre dogmas - evitar overengineering
- **OBRIGAT√ìRIO:** TypeScript strict mode sempre habilitado
- **OBRIGAT√ìRIO:** Toda funcionalidade DEVE ter testes correspondentes
- **PROIBIDO:** L√≥gica de neg√≥cio em rotas ou repositories
- **PROIBIDO:** Acoplamento direto com implementa√ß√µes concretas de infraestrutura
- **PROIBIDO:** Uso de `any` em TypeScript (exceto em casos extremamente raros e documentados)

### 1.2 Objetivos T√©cnicos de Longo Prazo

- Transformar este reposit√≥rio em boilerplate enterprise reutiliz√°vel
- Maximizar Developer Experience (DX) - foco em desenvolvimento de m√≥dulos de neg√≥cio
- Garantir testabilidade completa de todas as camadas
- Manter c√≥digo limpo, previs√≠vel e f√°cil de manter
- Permitir refatora√ß√µes seguras e graduais

---

## 2. ESTRUTURA DE PASTAS

### 2.1 Estrutura Obrigat√≥ria

```
src/
‚îú‚îÄ‚îÄ config/              # Configura√ß√µes da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ plugins/        # Plugins do Fastify organizados
‚îÇ   ‚îú‚îÄ‚îÄ app.ts          # Inst√¢ncia do Fastify
‚îÇ   ‚îú‚îÄ‚îÄ env.ts          # Valida√ß√£o de vari√°veis de ambiente
‚îÇ   ‚îî‚îÄ‚îÄ *.ts            # Outras configura√ß√µes
‚îú‚îÄ‚îÄ core/               # L√≥gica core compartilhada
‚îÇ   ‚îú‚îÄ‚îÄ domain/        # Entidades e Value Objects (quando necess√°rio)
‚îÇ   ‚îú‚îÄ‚îÄ interfaces/    # Contratos e interfaces compartilhadas
‚îÇ   ‚îú‚îÄ‚îÄ shared/        # Utilit√°rios compartilhados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/     # Tipos TypeScript compartilhados
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/     # Fun√ß√µes utilit√°rias
‚îÇ   ‚îî‚îÄ‚îÄ resilience/    # Circuit breaker, retry, etc.
‚îú‚îÄ‚îÄ http/               # Camada HTTP
‚îÇ   ‚îú‚îÄ‚îÄ errors/        # Classes de erro customizadas
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/   # Middlewares HTTP
‚îÇ   ‚îî‚îÄ‚îÄ error-handler.ts
‚îú‚îÄ‚îÄ infra/              # Infraestrutura (implementa√ß√µes concretas)
‚îÇ   ‚îú‚îÄ‚îÄ cache/         # Implementa√ß√£o de cache (Redis)
‚îÇ   ‚îú‚îÄ‚îÄ db/            # Implementa√ß√£o de banco (Prisma)
‚îÇ   ‚îú‚îÄ‚îÄ logger/        # Implementa√ß√£o de logger
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/    # M√©tricas e monitoramento
‚îú‚îÄ‚îÄ modules/            # M√≥dulos de dom√≠nio (feature-based)
‚îÇ   ‚îî‚îÄ‚îÄ {module-name}/
‚îÇ       ‚îú‚îÄ‚îÄ {module}.routes.ts      # Rotas HTTP
‚îÇ       ‚îú‚îÄ‚îÄ {module}.service.ts     # L√≥gica de neg√≥cio
‚îÇ       ‚îú‚îÄ‚îÄ {module}.repository.ts  # Acesso a dados
‚îÇ       ‚îú‚îÄ‚îÄ {module}.schemas.ts     # Schemas Zod
‚îÇ       ‚îú‚îÄ‚îÄ {module}.dto.ts         # DTOs e selects
‚îÇ       ‚îú‚îÄ‚îÄ {module}.serializers.ts # Serializa√ß√£o de respostas
‚îÇ       ‚îî‚îÄ‚îÄ __tests__/              # Testes do m√≥dulo
‚îú‚îÄ‚îÄ types/              # Tipos TypeScript globais (declara√ß√µes de m√≥dulo)
‚îî‚îÄ‚îÄ server.ts           # Entry point da aplica√ß√£o
```

### 2.2 Regras de Estrutura

- **OBRIGAT√ìRIO:** Cada m√≥dulo em `src/modules/` DEVE seguir a estrutura padr√£o acima
- **OBRIGAT√ìRIO:** Testes DEVE estar em `__tests__/` dentro do m√≥dulo correspondente
- **PROIBIDO:** Criar pastas fora da estrutura definida sem justificativa arquitetural
- **PROIBIDO:** Colocar c√≥digo de neg√≥cio fora de `src/modules/`
- **PROIBIDO:** Colocar implementa√ß√µes de infraestrutura fora de `src/infra/`
- **PROIBIDO:** Criar pasta `src/lib/` sem prop√≥sito claro definido

### 2.3 Depend√™ncias Entre Camadas

**Regra de Depend√™ncia (DEVE ser respeitada):**

```
modules/ ‚Üí pode depender de ‚Üí core/, http/errors, types/
modules/ ‚Üí N√ÉO PODE depender de ‚Üí infra/, config/

infra/ ‚Üí pode depender de ‚Üí core/interfaces, config/, types/
infra/ ‚Üí N√ÉO PODE depender de ‚Üí modules/

http/ ‚Üí pode depender de ‚Üí modules/, core/, types/
http/ ‚Üí N√ÉO PODE depender de ‚Üí infra/ diretamente

core/ ‚Üí pode depender de ‚Üí types/
core/ ‚Üí N√ÉO PODE depender de ‚Üí modules/, infra/, http/
```

- **OBRIGAT√ìRIO:** Respeitar a regra de depend√™ncias acima
- **PROIBIDO:** Depend√™ncias circulares entre m√≥dulos
- **PROIBIDO:** M√≥dulos dependerem de outros m√≥dulos diretamente (usar interfaces em `core/interfaces/`)

---

## 3. ROTAS E CONTROLLERS

### 3.1 Onde Rotas Devem Existir

- **OBRIGAT√ìRIO:** Rotas DEVE estar em `src/modules/{module}/{module}.routes.ts`
- **OBRIGAT√ìRIO:** Cada m√≥dulo DEVE ter um arquivo `{module}.routes.ts`
- **PROIBIDO:** Criar rotas fora de m√≥dulos
- **PROIBIDO:** Colocar m√∫ltiplos m√≥dulos em um √∫nico arquivo de rotas

### 3.2 Padr√£o de Rotas

**Template Obrigat√≥rio:**

```typescript
import type { FastifyPluginAsyncZod } from 'fastify-type-provider-zod';
import { authenticate, authorize } from '@/http/middlewares';
import { someSchema } from './module.schemas';
import { moduleService } from './module.service';

export const moduleRoutes: FastifyPluginAsyncZod = async (app) => {
  app.get(
    '/',
    {
      schema: someSchema,
      preHandler: [authenticate, authorize(['ADMIN'])],
    },
    async (request, reply) => {
      const result = await moduleService.someMethod(request.query);
      return reply.send(result);
    },
  );
};
```

### 3.3 O que uma Rota PODE Fazer

- **PODE:** Receber request e extrair dados (query, params, body)
- **PODE:** Chamar m√©todos de service
- **PODE:** Retornar resposta formatada
- **PODE:** Aplicar middlewares (auth, valida√ß√£o, etc.)

### 3.4 O que uma Rota N√ÉO PODE Fazer

- **PROIBIDO:** Conter l√≥gica de neg√≥cio
- **PROIBIDO:** Acessar banco de dados diretamente
- **PROIBIDO:** Acessar cache diretamente
- **PROIBIDO:** Fazer transforma√ß√µes complexas de dados (usar serializers)
- **PROIBIDO:** Tratar erros manualmente (deixar para error handler global)
- **PROIBIDO:** Validar dados manualmente (usar schemas Zod)

### 3.5 Padr√µes de Nomenclatura

- **OBRIGAT√ìRIO:** Arquivo de rotas: `{module}.routes.ts`
- **OBRIGAT√ìRIO:** Export da rota: `{module}Routes` (camelCase)
- **OBRIGAT√ìRIO:** Prefixo da rota: `/{module}` (plural, lowercase)
- **OBRIGAT√ìRIO:** Rotas RESTful quando aplic√°vel (GET, POST, PUT, DELETE)

### 3.6 Registro de Rotas

- **OBRIGAT√ìRIO:** Registrar rotas em `src/config/plugins/routes.config.ts`
- **OBRIGAT√ìRIO:** Prefixo DEVE ser definido no registro: `app.register(moduleRoutes, { prefix: '/module' })`
- **PROIBIDO:** Definir prefixo dentro do arquivo de rotas

---

## 4. SERVICES / USE CASES

### 4.1 Responsabilidade Exclusiva

- **OBRIGAT√ìRIO:** Services DEVE conter APENAS l√≥gica de neg√≥cio
- **OBRIGAT√ìRIO:** Services DEVE orquestrar chamadas a repositories
- **OBRIGAT√ìRIO:** Services DEVE validar regras de neg√≥cio antes de persistir
- **PROIBIDO:** Services conhecerem detalhes de HTTP (FastifyRequest, FastifyReply)
- **PROIBIDO:** Services conhecerem detalhes de infraestrutura diretamente

### 4.2 Padr√£o de Service

**Template Obrigat√≥rio (Futuro - com Dependency Injection):**

```typescript
// Interface em core/interfaces/
export interface IModuleRepository {
  findAll(skip: number, take: number): Promise<ModuleDTO[]>;
  // ...
}

export interface ICacheService {
  get<T>(key: string): Promise<T | null>;
  set(key: string, value: unknown, ttl: number): Promise<void>;
}

// Service
export class ModuleService {
  constructor(
    private repository: IModuleRepository,
    private cache: ICacheService,
  ) {}

  async findAll(page: number, limit: number) {
    // L√≥gica de neg√≥cio
  }
}
```

**Template Atual (Transi√ß√£o):**

```typescript
// Enquanto DI n√£o est√° implementado, usar objetos mas preparar para migra√ß√£o
export const moduleService = {
  async findAll(page: number, limit: number) {
    // L√≥gica de neg√≥cio
    // TODO: Migrar para classe com DI
  },
};
```

### 4.3 Comunica√ß√£o com Repositories

- **OBRIGAT√ìRIO:** Services DEVE usar interfaces de repositories (quando implementadas)
- **OBRIGAT√ìRIO:** Services N√ÉO PODE conhecer Prisma diretamente
- **PROIBIDO:** Services fazerem queries SQL ou Prisma diretamente

### 4.4 Tratamento de Erros em Services

- **OBRIGAT√ìRIO:** Services DEVE lan√ßar exce√ß√µes customizadas (`AppError` e subclasses)
- **OBRIGAT√ìRIO:** Mensagens de erro DEVE ser claras e espec√≠ficas
- **PROIBIDO:** Services retornarem `null` ou `undefined` para erros (lan√ßar exce√ß√£o)
- **PROIBIDO:** Services logarem erros diretamente (deixar para error handler)

### 4.5 Regras de Transa√ß√£o

- **OBRIGAT√ìRIO:** Opera√ß√µes que modificam m√∫ltiplas entidades DEVE usar transa√ß√µes
- **OBRIGAT√ìRIO:** Transa√ß√µes DEVE ser gerenciadas no n√≠vel de service
- **PROIBIDO:** Repositories gerenciarem transa√ß√µes (apenas executar)

### 4.6 Padr√µes de Nomenclatura

- **OBRIGAT√ìRIO:** Arquivo: `{module}.service.ts`
- **OBRIGAT√ìRIO:** Export: `{module}Service` (camelCase)
- **OBRIGAT√ìRIO:** M√©todos em camelCase, verbos descritivos: `findById`, `create`, `update`

---

## 5. REPOSITORIES E ACESSO A DADOS

### 5.1 Isolamento do Banco

- **OBRIGAT√ìRIO:** Repositories DEVE ser a √öNICA camada que acessa banco de dados
- **OBRIGAT√ìRIO:** Repositories DEVE usar Prisma (ou abstra√ß√£o futura)
- **PROIBIDO:** Outras camadas acessarem Prisma diretamente
- **PROIBIDO:** Repositories conterem l√≥gica de neg√≥cio

### 5.2 Padr√£o de Repository

**Template Obrigat√≥rio:**

```typescript
import type { Prisma } from 'generated/prisma/client';
import { prisma } from '@/infra/db/prisma';
import type { ModuleDTO, moduleSelect } from './module.dto';

export const moduleRepository = {
  async findAll(skip: number, take: number): Promise<ModuleDTO[]> {
    return await prisma.module.findMany({
      skip,
      take,
      select: moduleSelect,
      orderBy: { created_at: 'desc' },
    });
  },
  
  // Outros m√©todos...
};
```

### 5.3 Regras de Queries

- **OBRIGAT√ìRIO:** Sempre usar `select` espec√≠fico (nunca `select *`)
- **OBRIGAT√ìRIO:** Definir `moduleSelect` em `{module}.dto.ts`
- **OBRIGAT√ìRIO:** Queries DEVE retornar DTOs tipados
- **PROIBIDO:** Retornar modelos completos do Prisma (usar DTOs)

### 5.4 Pagina√ß√£o e Filtros

- **OBRIGAT√ìRIO:** M√©todos de listagem DEVE aceitar `skip` e `take`
- **OBRIGAT√ìRIO:** Ordena√ß√£o padr√£o DEVE ser definida
- **PODE:** Adicionar filtros opcionais como par√¢metros
- **PROIBIDO:** L√≥gica de pagina√ß√£o no service (apenas c√°lculo de skip/take)

### 5.5 Padr√µes de Nomenclatura

- **OBRIGAT√ìRIO:** Arquivo: `{module}.repository.ts`
- **OBRIGAT√ìRIO:** Export: `{module}Repository` (camelCase)
- **OBRIGAT√ìRIO:** M√©todos: `findById`, `findByEmail`, `findAll`, `create`, `update`, `delete`

---

## 6. ERROR HANDLING

### 6.1 Hierarquia de Erros

- **OBRIGAT√ìRIO:** Usar hierarquia de erros definida em `src/http/errors/app-error.ts`
- **OBRIGAT√ìRIO:** Criar novas classes de erro quando necess√°rio, estendendo `AppError`
- **PROIBIDO:** Lan√ßar `Error` gen√©rico diretamente
- **PROIBIDO:** Criar classes de erro fora de `src/http/errors/`

### 6.2 Classes de Erro Dispon√≠veis

```typescript
AppError                    // Base (400)
ConflictError              // 409
ResourceNotFoundError      // 404
UnauthorizedError          // 401
ForbiddenError             // 403
```

- **OBRIGAT√ìRIO:** Usar a classe de erro mais espec√≠fica poss√≠vel
- **OBRIGAT√ìRIO:** Mensagens DEVE ser claras e em ingl√™s (ou portugu√™s consistente)

### 6.3 Padroniza√ß√£o de Exce√ß√µes

- **OBRIGAT√ìRIO:** Todas as exce√ß√µes DEVE ter `statusCode` e `code`
- **OBRIGAT√ìRIO:** C√≥digo de erro DEVE seguir padr√£o: `ERR_{TIPO}` (ex: `ERR_NOT_FOUND`)
- **PROIBIDO:** Mensagens de erro exporem informa√ß√µes sens√≠veis em produ√ß√£o

### 6.4 Convers√£o para HTTP

- **OBRIGAT√ìRIO:** Error handler global em `src/http/error-handler.ts` DEVE converter todas as exce√ß√µes
- **OBRIGAT√ìRIO:** Formato de resposta DEVE ser consistente:
  ```typescript
  {
    timestamp: string;
    statusCode: number;
    code: string;
    message: string;
    fields?: Array<{ field: string; message: string }>; // Para valida√ß√£o
  }
  ```
- **PROIBIDO:** Rotas tratarem erros manualmente (deixar para error handler)

### 6.5 Logs Estruturados

- **OBRIGAT√ìRIO:** Erros DEVE ser logados pelo error handler
- **OBRIGAT√ìRIO:** Logs DEVE incluir contexto (correlation ID quando implementado)
- **PROIBIDO:** Logar informa√ß√µes sens√≠veis (senhas, tokens, etc.)

---

## 7. TYPESCRIPT

### 7.1 Strict Mode

- **OBRIGAT√ìRIO:** TypeScript strict mode DEVE estar sempre habilitado
- **OBRIGAT√ìRIO:** `tsconfig.json` DEVE ter `"strict": true`
- **PROIBIDO:** Desabilitar strict mode para "facilitar" desenvolvimento

### 7.2 Proibi√ß√£o de `any`

- **PROIBIDO:** Usar `any` em c√≥digo de produ√ß√£o
- **PODE:** Usar `any` apenas em:
  - Testes (quando necess√°rio para mocks)
  - Declara√ß√µes de tipos de bibliotecas externas sem tipos
  - Casos extremamente raros, COM justificativa em coment√°rio

### 7.3 Tipagem Expl√≠cita em Boundaries

- **OBRIGAT√ìRIO:** Tipar explicitamente par√¢metros de fun√ß√µes p√∫blicas
- **OBRIGAT√ìRIO:** Tipar explicitamente retornos de fun√ß√µes p√∫blicas
- **OBRIGAT√ìRIO:** Tipar explicitamente interfaces e tipos exportados
- **PODE:** Usar infer√™ncia de tipos em fun√ß√µes privadas/internas

### 7.4 Prefer√™ncia por Tipos Reutiliz√°veis

- **OBRIGAT√ìRIO:** Criar tipos reutiliz√°veis em `{module}.dto.ts` ou `core/shared/types/`
- **OBRIGAT√ìRIO:** Usar `satisfies` quando apropriado para garantir tipos
- **PROIBIDO:** Duplicar defini√ß√µes de tipos
- **PROIBIDO:** Usar tipos inline complexos em m√∫ltiplos lugares

### 7.5 Type Assertions

- **PROIBIDO:** Usar `as` type assertions sem justificativa
- **PODE:** Usar `as` apenas quando:
  - Type narrowing n√£o √© poss√≠vel
  - Integra√ß√£o com bibliotecas externas sem tipos adequados
  - COM coment√°rio explicando por qu√™

---

## 8. VALIDA√á√ÉO E SCHEMAS

### 8.1 Onde Validar

- **OBRIGAT√ìRIO:** Valida√ß√£o DEVE acontecer na camada HTTP (rotas)
- **OBRIGAT√ìRIO:** Usar Zod para valida√ß√£o de entrada (body, query, params)
- **OBRIGAT√ìRIO:** Schemas DEVE estar em `{module}.schemas.ts`
- **PROIBIDO:** Validar dados manualmente em services ou repositories

### 8.2 Como Validar

- **OBRIGAT√ìRIO:** Usar `fastify-type-provider-zod` para integra√ß√£o
- **OBRIGAT√ìRIO:** Schemas DEVE ser definidos com Zod
- **OBRIGAT√ìRIO:** Mensagens de erro DEVE ser customizadas e claras
- **OBRIGAT√ìRIO:** Schemas DEVE incluir `tags`, `summary` para Swagger

**Template Obrigat√≥rio:**

```typescript
import { z } from 'zod';

export const someSchema = {
  tags: ['Module'],
  summary: 'Descri√ß√£o da rota',
  body: z.object({
    field: z.string().min(3, 'Mensagem de erro clara'),
  }),
  querystring: z.object({
    page: z.coerce.number().default(1),
  }),
  response: {
    200: z.object({
      // Schema de resposta
    }),
  },
};
```

### 8.3 Evitar Duplica√ß√£o

- **OBRIGAT√ìRIO:** Reutilizar schemas base quando poss√≠vel
- **OBRIGAT√ìRIO:** Criar schemas compartilhados em `core/shared/types/` quando necess√°rio
- **PROIBIDO:** Duplicar valida√ß√µes entre m√≥dulos

### 8.4 Integra√ß√£o com Swagger

- **OBRIGAT√ìRIO:** Todos os schemas DEVE ser compat√≠veis com Swagger
- **OBRIGAT√ìRIO:** Incluir `tags` e `summary` em todos os schemas
- **OBRIGAT√ìRIO:** Documentar exemplos quando necess√°rio

---

## 9. SEGURAN√áA

### 9.1 Autentica√ß√£o e Autoriza√ß√£o

- **OBRIGAT√ìRIO:** Rotas protegidas DEVE usar middleware `authenticate`
- **OBRIGAT√ìRIO:** Rotas com controle de acesso DEVE usar middleware `authorize`
- **OBRIGAT√ìRIO:** Middlewares DEVE estar em `preHandler` do schema da rota
- **PROIBIDO:** Validar tokens manualmente em rotas
- **PROIBIDO:** Verificar roles manualmente em rotas

**Template Obrigat√≥rio:**

```typescript
app.get(
  '/protected',
  {
    schema: someSchema,
    preHandler: [authenticate, authorize(['ADMIN'])],
  },
  async (request, reply) => {
    // Handler
  },
);
```

### 9.2 Prote√ß√£o de Endpoints

- **OBRIGAT√ìRIO:** Endpoints p√∫blicos DEVE estar explicitamente marcados (sem `authenticate`)
- **OBRIGAT√ìRIO:** Endpoints administrativos DEVE usar `authorize(['ADMIN'])`
- **PROIBIDO:** Assumir que endpoint √© p√∫blico por padr√£o

### 9.3 Boas Pr√°ticas M√≠nimas Obrigat√≥rias

- **OBRIGAT√ìRIO:** Senhas DEVE ser hasheadas com Argon2
- **OBRIGAT√ìRIO:** Tokens JWT DEVE ter expira√ß√£o configurada
- **OBRIGAT√ìRIO:** Rate limiting DEVE estar configurado (global e por rota quando necess√°rio)
- **OBRIGAT√ìRIO:** Headers de seguran√ßa DEVE estar configurados (Helmet)
- **PROIBIDO:** Logar senhas, tokens ou informa√ß√µes sens√≠veis
- **PROIBIDO:** Expor informa√ß√µes sens√≠veis em mensagens de erro

---

## 10. PERFORMANCE E CACHE

### 10.1 Quando Usar Cache

- **PODE:** Usar cache para dados frequentemente acessados e raramente modificados
- **PODE:** Usar cache para resultados de queries pesadas
- **PROIBIDO:** Usar cache para dados cr√≠ticos de neg√≥cio sem fallback
- **PROIBIDO:** Usar cache para dados que mudam frequentemente

### 10.2 Onde o Cache Pode Existir

- **PODE:** Cache DEVE ser acessado via service (n√£o diretamente em rotas)
- **OBRIGAT√ìRIO:** Services DEVE usar interface de cache (quando implementada)
- **PROIBIDO:** Repositories acessarem cache diretamente
- **PROIBIDO:** Rotas acessarem cache diretamente

### 10.3 Proibi√ß√£o de Cache Acoplado

- **PROIBIDO:** Services conhecerem detalhes de implementa√ß√£o de cache (Redis, chaves, TTLs)
- **OBRIGAT√ìRIO:** Usar abstra√ß√£o de cache (`ICacheService` quando implementada)
- **OBRIGAT√ìRIO:** TTLs DEVE ser definidos em constantes, n√£o hardcoded

**Template Futuro:**

```typescript
// core/shared/constants.ts
export const CACHE_TTL = {
  USER_LIST: 60 * 5,
  USER_PROFILE: 60 * 10,
} as const;

// Service usando interface
class UsersService {
  constructor(private cache: ICacheService) {}
  
  async findAll() {
    await this.cache.set(key, value, CACHE_TTL.USER_LIST);
  }
}
```

### 10.4 Estrat√©gia de Invalida√ß√£o

- **OBRIGAT√ìRIO:** Invalidar cache quando dados s√£o modificados
- **OBRIGAT√ìRIO:** Usar padr√µes de chave consistentes: `{module}:{operation}:{params}`
- **PROIBIDO:** Invalidar cache de forma custosa (evitar `invalidateByPattern` em loops)

---

## 11. TESTES

### 11.1 Tipos de Testes Obrigat√≥rios

- **OBRIGAT√ìRIO:** Testes unit√°rios para services
- **OBRIGAT√ìRIO:** Testes unit√°rios para repositories
- **OBRIGAT√ìRIO:** Testes de integra√ß√£o para rotas
- **PODE:** Testes E2E para fluxos cr√≠ticos

### 11.2 Onde Cada Tipo Deve Existir

- **OBRIGAT√ìRIO:** Testes unit√°rios DEVE estar em `src/modules/{module}/__tests__/unit/`
- **OBRIGAT√ìRIO:** Testes de integra√ß√£o DEVE estar em `src/modules/{module}/__tests__/integration/`
- **OBRIGAT√ìRIO:** Testes E2E DEVE estar em `src/__tests__/e2e/` ou `tests/e2e/`
- **PROIBIDO:** Misturar testes unit√°rios e de integra√ß√£o no mesmo arquivo

### 11.3 Regras de Isolamento

- **OBRIGAT√ìRIO:** Testes unit√°rios DEVE usar mocks para depend√™ncias externas
- **OBRIGAT√ìRIO:** Testes DEVE ser isolados (n√£o depender de ordem de execu√ß√£o)
- **OBRIGAT√ìRIO:** Setup e teardown DEVE limpar estado entre testes
- **PROIBIDO:** Testes dependerem de estado global
- **PROIBIDO:** Testes fazerem chamadas HTTP reais (usar mocks ou test app)

### 11.4 Cobertura M√≠nima

- **OBRIGAT√ìRIO:** Cobertura m√≠nima DEVE ser 80% (configurar thresholds no `vitest.config.ts`)
- **OBRIGAT√ìRIO:** Novos m√≥dulos DEVE ter testes desde o in√≠cio
- **PROIBIDO:** Commitar c√≥digo sem testes correspondentes

### 11.5 Padr√µes de Testes

**Template Unit√°rio:**

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { moduleService } from '../module.service';
import { moduleRepository } from '../module.repository';

vi.mock('../module.repository');

describe('ModuleService', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('findAll', () => {
    it('should return paginated results', async () => {
      // Arrange
      vi.mocked(moduleRepository.findAll).mockResolvedValue([]);
      
      // Act
      const result = await moduleService.findAll(1, 10);
      
      // Assert
      expect(result).toBeDefined();
    });
  });
});
```

**Template Integra√ß√£o:**

```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { buildTestApp } from '@/__tests__/helpers/test-helpers';

describe('Module Routes', () => {
  let app: Awaited<ReturnType<typeof buildTestApp>>;

  beforeAll(async () => {
    app = await buildTestApp();
  });

  it('should return 200 for valid request', async () => {
    const response = await app.inject({
      method: 'GET',
      url: '/module',
    });

    expect(response.statusCode).toBe(200);
  });
});
```

---

## 12. OBSERVABILIDADE

### 12.1 Logging

- **OBRIGAT√ìRIO:** Usar logger do Fastify (`request.log` ou `app.log`)
- **OBRIGAT√ìRIO:** Logs DEVE ser estruturados (objetos, n√£o strings)
- **OBRIGAT√ìRIO:** Incluir contexto relevante nos logs
- **PROIBIDO:** Usar `console.log` em c√≥digo de produ√ß√£o
- **PROIBIDO:** Logar informa√ß√µes sens√≠veis

**Template:**

```typescript
request.log.info({
  msg: 'User created',
  userId: user.id,
  email: user.email,
});
```

### 12.2 Tratamento de Erros Inesperados

- **OBRIGAT√ìRIO:** Error handler global DEVE logar todos os erros
- **OBRIGAT√ìRIO:** Erros inesperados DEVE incluir stack trace em logs (n√£o na resposta)
- **OBRIGAT√ìRIO:** Preparar para correlation IDs (quando implementado)

### 12.3 Prepara√ß√£o para M√©tricas e Tracing

- **OBRIGAT√ìRIO:** Estrutura DEVE permitir adicionar m√©tricas sem quebrar c√≥digo existente
- **PODE:** Usar hooks do Fastify para coletar m√©tricas
- **PROIBIDO:** M√©tricas acoplarem c√≥digo de neg√≥cio

---

## 13. DEPENDENCY INJECTION (FUTURO)

### 13.1 Prepara√ß√£o para DI

- **OBRIGAT√ìRIO:** Criar interfaces para todas as depend√™ncias em `core/interfaces/`
- **OBRIGAT√ìRIO:** Services DEVE ser preparados para receber depend√™ncias via construtor
- **OBRIGAT√ìRIO:** Durante transi√ß√£o, manter compatibilidade com padr√£o atual

### 13.2 Interfaces Obrigat√≥rias (Quando Implementadas)

- **OBRIGAT√ìRIO:** `ICacheService` em `core/interfaces/cache.interface.ts`
- **OBRIGAT√ìRIO:** `IRepository<T>` base em `core/interfaces/repository.interface.ts`
- **OBRIGAT√ìRIO:** `ILogger` em `core/interfaces/logger.interface.ts`
- **OBRIGAT√ìRIO:** Interfaces espec√≠ficas de m√≥dulos quando necess√°rio

---

## 14. CONSTANTES E CONFIGURA√á√ïES

### 14.1 Magic Numbers

- **PROIBIDO:** Valores hardcoded no c√≥digo (magic numbers)
- **OBRIGAT√ìRIO:** Extrair constantes para arquivo `core/shared/constants.ts` ou `config/constants.ts`
- **OBRIGAT√ìRIO:** Nomear constantes de forma descritiva

**Exemplo:**

```typescript
// ‚ùå PROIBIDO
await cache.set(key, value, 60 * 5);

// ‚úÖ OBRIGAT√ìRIO
import { CACHE_TTL } from '@/core/shared/constants';
await cache.set(key, value, CACHE_TTL.USER_LIST);
```

### 14.2 Vari√°veis de Ambiente

- **OBRIGAT√ìRIO:** Todas as vari√°veis DEVE ser validadas em `src/config/env.ts`
- **OBRIGAT√ìRIO:** Usar Zod para valida√ß√£o de env
- **PROIBIDO:** Acessar `process.env` diretamente no c√≥digo
- **PROIBIDO:** Valores padr√£o hardcoded (usar defaults no schema Zod)

---

## 15. DOCUMENTA√á√ÉO

### 15.1 Documenta√ß√£o de C√≥digo

- **OBRIGAT√ìRIO:** Fun√ß√µes p√∫blicas DEVE ter JSDoc quando n√£o s√£o auto-explicativas
- **OBRIGAT√ìRIO:** Classes e interfaces complexas DEVE ter documenta√ß√£o
- **PODE:** Coment√°rios inline para l√≥gica complexa de neg√≥cio
- **PROIBIDO:** Coment√°rios √≥bvios que apenas repetem o c√≥digo

**Template JSDoc:**

```typescript
/**
 * Cria um novo usu√°rio no sistema
 * 
 * @param data - Dados do usu√°rio a ser criado
 * @returns Usu√°rio criado (sem senha)
 * @throws ConflictError se email j√° existir
 */
async create(data: CreateUserSchema): Promise<UserDTO> {
  // ...
}
```

### 15.2 Documenta√ß√£o de Arquitetura

- **OBRIGAT√ìRIO:** Decis√µes arquiteturais importantes DEVE ser documentadas em `docs/`
- **OBRIGAT√ìRIO:** README.md DEVE estar atualizado
- **OBRIGAT√ìRIO:** Guias de desenvolvimento DEVE estar em `docs/`

---

## 16. CONVEN√á√ïES DE C√ìDIGO

### 16.1 Nomenclatura

- **OBRIGAT√ìRIO:** Arquivos: `kebab-case.ts` ou `camelCase.ts` (seguir padr√£o do m√≥dulo)
- **OBRIGAT√ìRIO:** Exports: `camelCase` para objetos/fun√ß√µes, `PascalCase` para classes
- **OBRIGAT√ìRIO:** Vari√°veis e fun√ß√µes: `camelCase`
- **OBRIGAT√ìRIO:** Classes e tipos: `PascalCase`
- **OBRIGAT√ìRIO:** Constantes: `UPPER_SNAKE_CASE`

### 16.2 Imports

- **OBRIGAT√ìRIO:** Usar path aliases (`@/`) para imports internos
- **OBRIGAT√ìRIO:** Organizar imports: externos ‚Üí internos ‚Üí relativos
- **OBRIGAT√ìRIO:** Usar imports nomeados quando poss√≠vel
- **PROIBIDO:** Imports circulares entre m√≥dulos

### 16.3 Formata√ß√£o

- **OBRIGAT√ìRIO:** Usar Biome para formata√ß√£o autom√°tica
- **OBRIGAT√ìRIO:** Commits DEVE passar no lint (`pnpm lint`)
- **PROIBIDO:** Commitar c√≥digo n√£o formatado

---

## 17. REFATORA√á√ÉO E EVOLU√á√ÉO

### 17.1 Princ√≠pios de Refatora√ß√£o

- **OBRIGAT√ìRIO:** Refatora√ß√µes DEVE ser incrementais e test√°veis
- **OBRIGAT√ìRIO:** Manter compatibilidade durante transi√ß√µes
- **OBRIGAT√ìRIO:** Documentar mudan√ßas arquiteturais em `docs/`
- **PROIBIDO:** Refatora√ß√µes que quebram funcionalidades existentes sem testes

### 17.2 Migra√ß√£o Gradual

- **PODE:** Manter padr√£o antigo durante migra√ß√£o se necess√°rio
- **OBRIGAT√ìRIO:** Marcar c√≥digo legado com `TODO: Migrar para novo padr√£o`
- **OBRIGAT√ìRIO:** Priorizar novos m√≥dulos seguindo padr√£o novo

---

## 18. VALIDA√á√ÉO E ENFORCEMENT

### 18.1 Ferramentas de Valida√ß√£o

- **OBRIGAT√ìRIO:** Biome para linting e formata√ß√£o
- **OBRIGAT√ìRIO:** TypeScript para type checking
- **OBRIGAT√ìRIO:** Vitest para testes
- **OBRIGAT√ìRIO:** Pre-commit hooks (Husky) para valida√ß√£o autom√°tica

### 18.2 Code Review

- **OBRIGAT√ìRIO:** Revisar c√≥digo antes de merge
- **OBRIGAT√ìRIO:** Verificar ader√™ncia a estas rules
- **OBRIGAT√ìRIO:** Verificar cobertura de testes

---

## 19. EXCE√á√ïES E CASOS ESPECIAIS

### 19.1 Quando Quebrar as Rules

- **PODE:** Quebrar rules apenas com justificativa arquitetural clara
- **OBRIGAT√ìRIO:** Documentar exce√ß√£o em coment√°rio ou ADR
- **OBRIGAT√ìRIO:** Revisar exce√ß√£o em code review

### 19.2 Evolu√ß√£o das Rules

- **PODE:** Atualizar rules quando necess√°rio
- **OBRIGAT√ìRIO:** Documentar mudan√ßas em `docs/`
- **OBRIGAT√ìRIO:** Comunicar mudan√ßas √† equipe

---

## 20. CHECKLIST DE VALIDA√á√ÉO

Antes de commitar c√≥digo, verificar:

- [ ] C√≥digo segue estrutura de pastas definida
- [ ] Separa√ß√£o de responsabilidades respeitada
- [ ] TypeScript strict mode sem erros
- [ ] Sem uso de `any` (exceto casos documentados)
- [ ] Testes implementados e passando
- [ ] Schemas Zod definidos para valida√ß√£o
- [ ] Erros usando classes customizadas
- [ ] Sem magic numbers (constantes extra√≠das)
- [ ] Imports organizados e usando path aliases
- [ ] C√≥digo formatado (Biome)
- [ ] Documenta√ß√£o atualizada quando necess√°rio

---

**√öltima atualiza√ß√£o:** Janeiro 2025  
**Vers√£o:** 1.0.0  
**Manuten√ß√£o:** Este arquivo DEVE ser atualizado quando padr√µes mudarem

